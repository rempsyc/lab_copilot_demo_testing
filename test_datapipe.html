<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSF DataPipe Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 4px; }
        button:hover { background-color: #0056b3; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; }
        .experiment-id { font-family: monospace; background-color: #e9ecef; padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>OSF DataPipe Configuration Test</h1>
    
    <div class="warning">
        <strong>Purpose:</strong> This test helps verify if the OSF DataPipe endpoint is properly configured for experiment ID <span class="experiment-id">Cb1DhSdND5ek</span>.
    </div>

    <h2>Current Configuration</h2>
    <ul>
        <li><strong>Experiment ID:</strong> <span class="experiment-id">Cb1DhSdND5ek</span></li>
        <li><strong>DataPipe URL:</strong> <span class="experiment-id">https://pipe.jspsych.org/api/data/</span></li>
        <li><strong>Expected Result:</strong> Success (200) or detailed error message</li>
    </ul>

    <h2>DataPipe Configuration Formats</h2>
    
    <div class="warning">
        <p><strong>Important:</strong> There are two different formats you need to understand:</p>
        <ul>
            <li><strong>jsPsych Plugin Configuration:</strong> What you write in your jsPsych experiment code</li>
            <li><strong>Raw API Data:</strong> What actually gets sent to the DataPipe server</li>
        </ul>
        <p>The jsPsych plugin automatically converts the first format into the second format before sending to the API.</p>
    </div>
    <h2>Live API Testing</h2>
    <button onclick="testDataFormatOffline()">üîç Test Data Format (Local)</button>
    <button onclick="testDataPipeAPI()">üåê Test OSF DataPipe (Live)</button>
    <button onclick="clearResults()">Clear Results</button>
    
    <div class="warning">
        <p><strong>Recommended:</strong> Start with "Test Data Format (Local)" to validate your data format before testing the live API.</p>
    </div>

    <div id="test-results"></div>

    <h2>Manual Testing Instructions</h2>
    <div class="warning">
        <p><strong>If the automated test fails, try these steps manually:</strong></p>
        <ol>
            <li>Go to <a href="https://pipe.jspsych.org" target="_blank">pipe.jspsych.org</a></li>
            <li>Check if experiment ID <span class="experiment-id">Cb1DhSdND5ek</span> is listed</li>
            <li>Verify that the experiment is active and properly configured</li>
            <li>Test manual data submission with the sample data below</li>
        </ol>
    </div>

    <h3>jsPsych DataPipe Plugin Configuration</h3>
    <div class="warning">
        <p><strong>This is the format you use in your jsPsych experiment:</strong></p>
    </div>
    <pre id="jspsych-config">const save_data = {
  type: jsPsychPipe,
  action: "save",
  experiment_id: "Cb1DhSdND5ek",
  filename: "trust_game_" + Date.now() + ".csv",
  data_string: () => jsPsych.data.get().csv()
};</pre>

    <h3>Raw API Data Format (What Gets Sent)</h3>
    <div class="warning">
        <p><strong>This is the actual JSON data that gets sent to the DataPipe API (UPDATED FORMAT):</strong></p>
    </div>
    <pre id="sample-data">{
  "experimentID": "Cb1DhSdND5ek",
  "filename": "test_data_manual.csv",
  "data": "trial_type,trial_index\n\"smoke-test\",0"
}</pre>

    <h3>Command Line Testing (curl)</h3>
    <div class="warning">
        <p><strong>Copy and run this curl command to test the raw API directly (UPDATED FORMAT):</strong></p>
        <pre id="curl-command">curl -X POST https://pipe.jspsych.org/api/data/ \
-H "Content-Type: application/json" \
-d '{
  "experimentID": "Cb1DhSdND5ek",
  "filename": "test_data_curl.csv",
  "data": "trial_type,trial_index\n\"smoke-test\",0"
}'</pre>
        <p><strong>Expected Results:</strong></p>
        <ul>
            <li><strong>Success (200):</strong> Data submitted successfully</li>
            <li><strong>400 Error:</strong> Missing or invalid parameters (check the error message for details)</li>
            <li><strong>404 Error:</strong> Experiment ID not found or not configured</li>
            <li><strong>Network Error:</strong> Connection issues or CORS restrictions</li>
        </ul>
    </div>

    <h3>Alternative Testing Methods</h3>
    <div class="warning">
        <p><strong>If the DataPipe API continues to fail, try these approaches:</strong></p>
        <ol>
            <li><strong>Use curl/Postman:</strong> Test the API directly with the JSON data above</li>
            <li><strong>Check experiment registration:</strong> Verify your experiment ID at <a href="https://pipe.jspsych.org" target="_blank">pipe.jspsych.org</a></li>
            <li><strong>Test with minimal jsPsych:</strong> Use the <a href="minimal_datapipe_test.html" target="_blank">minimal jsPsych test</a> (requires internet)</li>
            <li><strong>Use the local format tester:</strong> Click "Test Data Format (Local)" above to validate your data structure</li>
            <li><strong>Read troubleshooting guide:</strong> See <a href="DATAPIPE_TROUBLESHOOTING.md" target="_blank">DATAPIPE_TROUBLESHOOTING.md</a> for detailed analysis</li>
        </ol>
    </div>

    <script>
        // Define jsPsychPipe for testing purposes (normally this would be imported)
        const jsPsychPipe = "jsPsychPipe";
        
        function generateComprehensiveTestData() {
            // Generate test data matching the exact format from the experiment
            const headers = [
                'trial_type', 'trial_index'
            ];
            
            // Generate simple test data matching PowerShell example
            const rows = [
                ['smoke-test', 0]
            ];
            
            // Format as CSV
            const csvRows = [headers, ...rows];
            return csvRows.map(row => 
                row.map(field => `"${field}"`).join(',')
            ).join('\n');
        }

        function testDataFormatOffline() {
            const resultsDiv = document.getElementById('test-results');
            
            // Show loading state
            resultsDiv.innerHTML = '<div class="warning">Testing DataPipe data format locally...</div>';
            
            try {
                const testData = {
                    experimentID: 'Cb1DhSdND5ek',
                    filename: 'test_data_' + Date.now() + '.csv',
                    data: generateComprehensiveTestData()
                };
                
                // Validate the data format
                const validation = validateDataPipeFormat(testData);
                
                if (validation.valid) {
                    resultsDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Data Format Validation Passed!</h3>
                            <p><strong>Status:</strong> Local validation successful</p>
                            <p><strong>All required parameters present:</strong></p>
                            <ul>
                                <li>‚úÖ experimentID: "${testData.experimentID}"</li>
                                <li>‚úÖ filename: "${testData.filename}"</li>
                                <li>‚úÖ data: ${testData.data.split('\n').length} rows</li>
                            </ul>
                            <p><strong>Data Preview:</strong></p>
                            <pre>${testData.data.split('\n').slice(0, 3).join('\n')}...</pre>
                            <p><strong>Next Steps:</strong></p>
                            <ol>
                                <li>Verify experiment ID "${testData.experimentID}" is registered at <a href="https://pipe.jspsych.org" target="_blank">pipe.jspsych.org</a></li>
                                <li>Check that your OSF project has DataPipe enabled</li>
                                <li>Try the live API test if format looks correct</li>
                            </ol>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <h3>‚ùå Data Format Validation Failed</h3>
                            <p><strong>Missing or invalid parameters:</strong></p>
                            <ul>
                                ${validation.errors.map(error => `<li>‚ùå ${error}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Validation Error</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }

        async function testDataPipeAPI() {
            const resultsDiv = document.getElementById('test-results');
            
            // Show loading state
            resultsDiv.innerHTML = '<div class="warning">Testing OSF DataPipe API...</div>';
            
            try {
                const testData = {
                    experimentID: 'Cb1DhSdND5ek',
                    filename: 'test_data_' + Date.now() + '.csv',
                    data: generateComprehensiveTestData()
                };
                
                console.log('Testing OSF DataPipe with data:', testData);
                
                const response = await fetch('https://pipe.jspsych.org/api/data/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                const responseText = await response.text();
                
                if (response.ok) {
                    resultsDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Success!</h3>
                            <p>OSF DataPipe submission successful!</p>
                            <p><strong>Status:</strong> ${response.status}</p>
                            <p><strong>Response:</strong></p>
                            <pre>${responseText}</pre>
                        </div>
                    `;
                } else {
                    let errorDetails = responseText;
                    try {
                        const errorJson = JSON.parse(responseText);
                        if (errorJson.error && errorJson.message) {
                            errorDetails = `${errorJson.error}: ${errorJson.message}`;
                        }
                    } catch (e) {
                        // Keep original response text if not JSON
                    }
                    
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <h3>‚ùå DataPipe API Error</h3>
                            <p><strong>Status:</strong> ${response.status}</p>
                            <p><strong>Error:</strong> ${errorDetails}</p>
                            <p><strong>Most Likely Cause:</strong> Experiment ID "Cb1DhSdND5ek" is not properly registered in DataPipe</p>
                            <p><strong>Troubleshooting Steps:</strong></p>
                            <ol>
                                <li>Go to <a href="https://pipe.jspsych.org" target="_blank">pipe.jspsych.org</a> and verify the experiment is registered</li>
                                <li>Check your OSF project DataPipe configuration</li>
                                <li>Contact OSF DataPipe support if the experiment should be working</li>
                                <li>Use the CSV download fallback in your experiment</li>
                            </ol>
                            <p><strong>Request Data (for support):</strong></p>
                            <pre>${JSON.stringify(testData, null, 2)}</pre>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('DataPipe test failed:', error);
                
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Network Error</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Possible Causes:</strong></p>
                        <ul>
                            <li>Network connectivity issues</li>
                            <li>CORS restrictions</li>
                            <li>Firewall blocking pipe.jspsych.org</li>
                            <li>Browser security settings</li>
                        </ul>
                        <p><strong>Workaround:</strong> The experiment fallback (CSV download) is working correctly.</p>
                    </div>
                `;
            }
        }

        function validateDataPipeFormat(data) {
            const errors = [];
            const requiredFields = ['experimentID', 'filename', 'data'];
            
            // Check required fields
            requiredFields.forEach(field => {
                if (!data[field] || data[field].toString().trim() === '') {
                    errors.push(`Missing required field: ${field}`);
                }
            });
            
            // Validate experimentID format
            if (data.experimentID && !/^[a-zA-Z0-9_-]+$/.test(data.experimentID)) {
                errors.push(`Invalid experimentID format: ${data.experimentID} (should contain only letters, numbers, underscores, and dashes)`);
            }
            
            // Validate data is CSV format
            if (data.data) {
                const lines = data.data.split('\n');
                if (lines.length < 2) {
                    errors.push('data should contain at least header and one data row');
                }
                
                // Check if first line looks like headers
                const headers = lines[0];
                if (!headers.includes('trial_type') || !headers.includes('trial_index')) {
                    errors.push('data should include standard jsPsych headers (trial_type, trial_index)');
                }
            }
            
            return {
                valid: errors.length === 0,
                errors: errors
            };
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }
    </script>
</body>
</html>