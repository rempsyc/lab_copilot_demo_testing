<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSF DataPipe Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 4px; }
        button:hover { background-color: #0056b3; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .experiment-id { font-family: monospace; background-color: #e9ecef; padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>OSF DataPipe Configuration Test</h1>
    
    <div class="warning">
        <strong>Purpose:</strong> This test helps verify if the OSF DataPipe endpoint is properly configured for experiment ID <span class="experiment-id">xMeT3pzdPmF9</span>.
    </div>

    <h2>Current Configuration</h2>
    <ul>
        <li><strong>Experiment ID:</strong> <span class="experiment-id">xMeT3pzdPmF9</span></li>
        <li><strong>DataPipe URL:</strong> <span class="experiment-id">https://pipe.jspsych.org/api/data/</span></li>
        <li><strong>Expected Result:</strong> Success (200) or detailed error message</li>
    </ul>

    <h2>Test DataPipe Submission</h2>
    <button onclick="testDataPipeOffline()">üîç Test Data Format (Local)</button>
    <button onclick="testDataPipeSubmission()">üåê Test OSF DataPipe (Live)</button>
    <button onclick="clearResults()">Clear Results</button>
    
    <div class="warning">
        <p><strong>Recommended:</strong> Start with "Test Data Format (Local)" to validate your data format before testing the live API.</p>
    </div>

    <div id="test-results"></div>

    <h2>Manual Testing Instructions</h2>
    <div class="warning">
        <p><strong>If the automated test fails, try these steps manually:</strong></p>
        <ol>
            <li>Go to <a href="https://pipe.jspsych.org" target="_blank">pipe.jspsych.org</a></li>
            <li>Check if experiment ID <span class="experiment-id">xMeT3pzdPmF9</span> is listed</li>
            <li>Verify that the experiment is active and properly configured</li>
            <li>Test manual data submission with the sample data below</li>
        </ol>
    </div>

    <h3>Sample Test Data (Improved Format)</h3>
    <pre id="sample-data">{
  "action": "save",
  "experiment_id": "xMeT3pzdPmF9",
  "session_id": "test_session_manual",
  "filename": "test_data_manual.csv",
  "data_string": "trial_type,trial_index,time_elapsed,rt,experiment_id,session_id,participant_id,round,amount_sent,amount_kept,partner_received,amount_returned,final_earnings,return_rate,trial_timestamp,participant_age,participant_gender,participant_field,experiment_version,experiment_name,participant_timestamp,total_earnings,average_amount_sent,trust_pattern,completion_time\n\"trust-game-trial\",0,10000,2500,\"xMeT3pzdPmF9\",\"test_session_manual\",\"test_participant\",1,5,5,25,7,12,0.28,\"2024-01-01T00:00:00.000Z\",25,\"Female\",\"Psychology\",\"1.0\",\"trust_game\",\"2024-01-01T00:00:00.000Z\",50,6,\"Moderate Trust\",\"2024-01-01T00:00:00.000Z\""
}</pre>

    <h3>Alternative Testing Methods</h3>
    <div class="warning">
        <p><strong>If the DataPipe API continues to fail, try these approaches:</strong></p>
        <ol>
            <li><strong>Use curl/Postman:</strong> Test the API directly with the JSON data above</li>
            <li><strong>Check experiment registration:</strong> Verify your experiment ID at <a href="https://pipe.jspsych.org" target="_blank">pipe.jspsych.org</a></li>
            <li><strong>Test with minimal jsPsych:</strong> Use the <a href="minimal_datapipe_test.html" target="_blank">minimal jsPsych test</a> (requires internet)</li>
            <li><strong>Use the local format tester:</strong> Click "Test Data Format (Local)" above to validate your data structure</li>
        </ol>
    </div>

    <h3>Command Line Testing (curl)</h3>
    <div class="warning">
        <p><strong>Copy and run this curl command to test the API directly:</strong></p>
        <pre id="curl-command">curl -X POST https://pipe.jspsych.org/api/data/ \
-H "Content-Type: application/json" \
-d '{
  "action": "save",
  "experiment_id": "xMeT3pzdPmF9",
  "session_id": "test_session_curl",
  "filename": "test_data_curl.csv",
  "data_string": "trial_type,trial_index,time_elapsed,rt,experiment_id,session_id,participant_id,round,amount_sent,amount_kept,partner_received,amount_returned,final_earnings,return_rate,trial_timestamp,participant_age,participant_gender,participant_field,experiment_version,experiment_name,participant_timestamp,total_earnings,average_amount_sent,trust_pattern,completion_time\n\"trust-game-trial\",0,10000,2500,\"xMeT3pzdPmF9\",\"test_session_curl\",\"test_participant\",1,5,5,25,7,12,0.28,\"2024-01-01T00:00:00.000Z\",25,\"Female\",\"Psychology\",\"1.0\",\"trust_game\",\"2024-01-01T00:00:00.000Z\",50,6,\"Moderate Trust\",\"2024-01-01T00:00:00.000Z\""
}'</pre>
        <p><strong>Expected Results:</strong></p>
        <ul>
            <li><strong>Success (200):</strong> Data submitted successfully</li>
            <li><strong>400 Error:</strong> Missing or invalid parameters (check the error message for details)</li>
            <li><strong>404 Error:</strong> Experiment ID not found or not configured</li>
            <li><strong>Network Error:</strong> Connection issues or CORS restrictions</li>
        </ul>
    </div>

    <script>
        async function testDataPipeSubmission() {
            const resultsDiv = document.getElementById('test-results');
            
            // Show loading state
            resultsDiv.innerHTML = '<div class="warning">Testing OSF DataPipe submission...</div>';
            
            // Generate comprehensive test data matching jsPsych DataPipe format
            const testData = {
                action: "save",
                experiment_id: 'xMeT3pzdPmF9',
                session_id: 'test_session_' + Date.now(),
                filename: 'test_data_' + Date.now() + '.csv',
                data_string: generateComprehensiveTestData()
            };
            
            try {
                console.log('Testing OSF DataPipe with data:', testData);
                console.log('Data string preview:', testData.data_string.substring(0, 200) + '...');
                
                // First validate locally
                const validation = validateDataPipeFormat(testData);
                if (!validation.valid) {
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <h3>‚ùå Data Format Error</h3>
                            <p><strong>Fix these issues before testing live API:</strong></p>
                            <ul>
                                ${validation.errors.map(error => `<li>‚ùå ${error}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                    return;
                }
                
                const response = await fetch('https://pipe.jspsych.org/api/data/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                const responseText = await response.text();
                console.log('Response status:', response.status);
                console.log('Response text:', responseText);
                
                if (response.ok) {
                    resultsDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Success!</h3>
                            <p>OSF DataPipe submission successful!</p>
                            <p><strong>Status:</strong> ${response.status}</p>
                            <p><strong>Response:</strong></p>
                            <pre>${responseText}</pre>
                            <p><strong>Data submitted:</strong></p>
                            <ul>
                                <li>Experiment ID: ${testData.experiment_id}</li>
                                <li>Session ID: ${testData.session_id}</li>
                                <li>Filename: ${testData.filename}</li>
                                <li>Data rows: ${testData.data_string.split('\n').length}</li>
                            </ul>
                        </div>
                    `;
                } else {
                    // Try to parse error response
                    let errorDetails = responseText;
                    try {
                        const errorJson = JSON.parse(responseText);
                        if (errorJson.error && errorJson.message) {
                            errorDetails = `${errorJson.error}: ${errorJson.message}`;
                        }
                    } catch (e) {
                        // Keep original response text if not JSON
                    }
                    
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <h3>‚ùå DataPipe Error</h3>
                            <p><strong>Status:</strong> ${response.status}</p>
                            <p><strong>Error Details:</strong> ${errorDetails}</p>
                            <p><strong>Request Data:</strong></p>
                            <pre>${JSON.stringify(testData, null, 2)}</pre>
                            <p><strong>Troubleshooting Steps:</strong></p>
                            <ol>
                                <li>Verify experiment ID "${testData.experiment_id}" is registered at <a href="https://pipe.jspsych.org" target="_blank">pipe.jspsych.org</a></li>
                                <li>Check that your OSF project has DataPipe properly configured</li>
                                <li>Ensure the experiment is active and accepting data</li>
                                <li>Try copying the request data above and testing with curl or Postman</li>
                            </ol>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('DataPipe test failed:', error);
                
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Network Error</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Possible Causes:</strong></p>
                        <ul>
                            <li>Network connectivity issues</li>
                            <li>CORS restrictions</li>
                            <li>Firewall blocking pipe.jspsych.org</li>
                            <li>Browser security settings</li>
                        </ul>
                        <p><strong>Workaround:</strong> The experiment fallback (CSV download) is working correctly.</p>
                    </div>
                `;
            }
        }
        
        function generateComprehensiveTestData() {
            // Generate test data matching the exact format from the experiment
            const headers = [
                'trial_type', 'trial_index', 'time_elapsed', 'rt', 'experiment_id', 'session_id',
                'participant_id', 'round', 'amount_sent', 'amount_kept', 'partner_received',
                'amount_returned', 'final_earnings', 'return_rate', 'trial_timestamp',
                'participant_age', 'participant_gender', 'participant_field', 'experiment_version',
                'experiment_name', 'participant_timestamp', 'total_earnings', 'average_amount_sent',
                'trust_pattern', 'completion_time'
            ];
            
            // Generate sample trial data
            const sessionId = 'test_session_' + Date.now();
            const participantId = 'test_participant_' + Date.now();
            const timestamp = new Date().toISOString();
            
            const rows = [
                [
                    'trust-game-trial', 0, 10000, 2500, 'xMeT3pzdPmF9', sessionId,
                    participantId, 1, 5, 5, 25, 7, 12, 0.28, timestamp,
                    25, 'Female', 'Psychology', '1.0', 'trust_game', timestamp,
                    50, 6, 'Moderate Trust', timestamp
                ],
                [
                    'trust-game-trial', 1, 20000, 1800, 'xMeT3pzdPmF9', sessionId,
                    participantId, 2, 8, 2, 34, 12, 14, 0.35, timestamp,
                    25, 'Female', 'Psychology', '1.0', 'trust_game', timestamp,
                    50, 6, 'Moderate Trust', timestamp
                ]
            ];
            
            // Format as CSV
            const csvRows = [headers, ...rows];
            return csvRows.map(row => 
                row.map(field => `"${field}"`).join(',')
            ).join('\n');
        }

        async function testDataPipeOffline() {
            const resultsDiv = document.getElementById('test-results');
            
            // Show loading state
            resultsDiv.innerHTML = '<div class="warning">Testing DataPipe data format locally...</div>';
            
            try {
                const testData = {
                    action: "save",
                    experiment_id: 'xMeT3pzdPmF9',
                    session_id: 'test_session_' + Date.now(),
                    filename: 'test_data_' + Date.now() + '.csv',
                    data_string: generateComprehensiveTestData()
                };
                
                // Validate the data format
                const validation = validateDataPipeFormat(testData);
                
                if (validation.valid) {
                    resultsDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Data Format Validation Passed!</h3>
                            <p><strong>Status:</strong> Local validation successful</p>
                            <p><strong>All required parameters present:</strong></p>
                            <ul>
                                <li>‚úÖ action: "${testData.action}"</li>
                                <li>‚úÖ experiment_id: "${testData.experiment_id}"</li>
                                <li>‚úÖ session_id: "${testData.session_id}"</li>
                                <li>‚úÖ filename: "${testData.filename}"</li>
                                <li>‚úÖ data_string: ${testData.data_string.split('\n').length} rows</li>
                            </ul>
                            <p><strong>Data Preview:</strong></p>
                            <pre>${testData.data_string.split('\n').slice(0, 3).join('\n')}...</pre>
                            <p><strong>Next Steps:</strong></p>
                            <ol>
                                <li>Verify experiment ID "${testData.experiment_id}" is registered at <a href="https://pipe.jspsych.org" target="_blank">pipe.jspsych.org</a></li>
                                <li>Check that your OSF project has DataPipe enabled</li>
                                <li>Try the live API test if format looks correct</li>
                            </ol>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <h3>‚ùå Data Format Validation Failed</h3>
                            <p><strong>Missing or invalid parameters:</strong></p>
                            <ul>
                                ${validation.errors.map(error => `<li>‚ùå ${error}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Validation Error</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }

        function validateDataPipeFormat(data) {
            const errors = [];
            const requiredFields = ['action', 'experiment_id', 'session_id', 'filename', 'data_string'];
            
            // Check required fields
            requiredFields.forEach(field => {
                if (!data[field] || data[field].toString().trim() === '') {
                    errors.push(`Missing required field: ${field}`);
                }
            });
            
            // Validate action
            if (data.action && data.action !== 'save') {
                errors.push(`Invalid action: ${data.action} (should be "save")`);
            }
            
            // Validate experiment_id format
            if (data.experiment_id && !/^[a-zA-Z0-9_-]+$/.test(data.experiment_id)) {
                errors.push(`Invalid experiment_id format: ${data.experiment_id} (should contain only letters, numbers, underscores, and dashes)`);
            }
            
            // Validate data_string is CSV format
            if (data.data_string) {
                const lines = data.data_string.split('\n');
                if (lines.length < 2) {
                    errors.push('data_string should contain at least header and one data row');
                }
                
                // Check if first line looks like headers
                const headers = lines[0];
                if (!headers.includes('trial_type') || !headers.includes('trial_index')) {
                    errors.push('data_string should include standard jsPsych headers (trial_type, trial_index)');
                }
            }
            
            return {
                valid: errors.length === 0,
                errors: errors
            };
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }
    </script>
</body>
</html>